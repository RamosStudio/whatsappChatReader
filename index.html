<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ù‚Ø§Ø±Ø¦ Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨</title>
  <style>
    :root{
      --brand:#008069; --brand-dark:#006f5c;
      --bg:#f0f2f5; --panel:#fafafa; --bubble-me:#d1ffd1; --bubble-other:#ffffff;
      --bg-dark:#18191a; --panel-dark:#242526; --bubble-me-dark:#056162; --bubble-other-dark:#3a3b3c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tahoma",system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:#111;transition:.25s}
    .dark{background:var(--bg-dark);color:#e4e6eb}
    header{position:sticky;top:0;z-index:5;padding:12px;background:var(--brand);color:#fff;text-align:center;font-size:22px;font-weight:700}

    .controls{
      position:sticky; top:56px; z-index:4;
      display:flex; flex-direction:column; gap:8px; padding:12px; background:var(--panel);
      border-bottom:1px solid #e6e6e6;
    }
    .dark .controls{background:var(--panel-dark); border-bottom-color:#3a3b3c}

    input[type="file"]{display:none}
    .file-label, .btn, .search{
      padding:12px 14px; border:none; border-radius:14px; font-size:14px;
    }
    .file-label, .btn{background:var(--brand); color:#fff; cursor:pointer}
    .file-label:hover, .btn:hover{background:var(--brand-dark)}
    .search{background:#fff; flex:1}
    .dark .search{background:#333; color:#fff}

    /* ØµÙÙˆÙ Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .row{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .row.icons .btn{flex:0 0 auto; padding:2px; font-size:13px; border-radius:50%}

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    #chat{height:calc(100vh - 56px - 120px);padding:12px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column}
    .msg{margin:8px 0;padding:18px;border-radius:20px;max-width:95%;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,.06);font-size:18px;line-height:1.45;display:flex;flex-direction:column}
    .sender{font-weight:700;font-size:14px;opacity:.9;margin-bottom:8px}
    .from{background:var(--bubble-me);margin-left:auto;text-align:right}
    .to{background:var(--bubble-other);margin-right:auto;text-align:left}
    .dark .from{background:var(--bubble-me-dark);color:#fff}
    .dark .to{background:var(--bubble-other-dark);color:#fff}
    .from .sender{color:#0c7a43}
    .to .sender{color:#1c6dd0}
    mark{background:yellow;padding:0 .2em}

    /* Ø´Ø§Ø´Ø§Øª Ø£ÙˆØ³Ø¹ */
    @media (min-width: 700px){
      .controls{flex-direction:row;flex-wrap:wrap;align-items:center}
      .row{flex:1}
      .row.icons .btn{border-radius:12px; font-size:16px; padding:10px 14px}
      #chat{height:calc(100vh - 56px - 88px)}
      .msg{max-width:75%;font-size:18px;padding:12px 16px}
      .sender{font-size:14px}
    }
    @media (min-width: 1100px){.msg{max-width:65%}}
  </style>
</head>
<body>
  <header>ğŸ’¬ Ù‚Ø§Ø±Ø¦ Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨</header>

  <div class="controls">
    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ -->
    <div class="row">
      <label for="fileInput" class="file-label">ğŸ“‚ Ù…Ù„Ù</label>
      <input type="file" id="fileInput" accept=".txt" />
      <button class="btn" onclick="toggleDark()">ğŸŒ™/â˜€ï¸</button>
    </div>

    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
    <div class="row icons">
      <input type="text" id="searchInput" class="search" placeholder="ğŸ”..." />
      <button class="btn" onclick="searchChat()">ğŸ”</button>
      <button class="btn" onclick="prevResult()">â®ï¸</button>
      <button class="btn" onclick="nextResult()">â­ï¸</button>
      <button class="btn" onclick="scrollTopChat()">â¬†ï¸</button>
      <button class="btn" onclick="scrollBottomChat()">â¬‡ï¸</button>
    </div>
  </div>

  <div id="chat" aria-live="polite"></div>

  <script>
    const chatDiv = document.getElementById("chat");
    let messages = [], results = [], currentIndex = -1;

    document.getElementById("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      renderChat(text);
      requestAnimationFrame(() => scrollBottomChat());
    });

    function renderChat(chatText) {
      chatDiv.innerHTML = ""; messages = [];
      const lines = chatText.split("\n");
      for (const line of lines) {
        if (!line.trim()) continue;
        const parts = line.split(" - ");
        if (parts.length < 2) continue;
        const msgPart = parts.slice(1).join(" - ");
        const senderSplit = msgPart.split(": ");
        if (senderSplit.length < 2) continue;
        const sender = senderSplit[0];
        const message = senderSplit.slice(1).join(": ");
        const msgDiv = document.createElement("div");
        const isMe = guessIsMe(sender);
        msgDiv.className = "msg " + (isMe ? "from" : "to");
        msgDiv.innerHTML = `<div class="sender">${sender}</div><div class="text">${message}</div>`;
        chatDiv.appendChild(msgDiv); messages.push(msgDiv);
      }
    }

    function guessIsMe(name){ return /ammar|Ø¹Ù…Ù‘Ø§Ø±|Ø¹Ù…Ø§Ø±/i.test(name); }

    function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");}
    function searchChat() {
      const term=document.getElementById("searchInput").value.trim(); if(!term) return;
      results=[]; currentIndex=-1;
      messages.forEach(m=>{
        m.querySelector(".text").innerHTML=m.querySelector(".text").innerHTML.replace(/<mark>|<\/mark>/g,"");
        if(m.innerText.includes(term)){
          results.push(m);
          m.querySelector(".text").innerHTML=m.querySelector(".text").innerHTML.replace(new RegExp(escapeRegExp(term),"gi"),t=>`<mark>${t}</mark>`);
        }
      });
      if(results.length){currentIndex=0;scrollToResult();} else alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬");
    }
    function nextResult(){if(results.length){currentIndex=(currentIndex+1)%results.length;scrollToResult();}}
    function prevResult(){if(results.length){currentIndex=(currentIndex-1+results.length)%results.length;scrollToResult();}}
    function scrollToResult(){results[currentIndex].scrollIntoView({behavior:"smooth",block:"center"});}
    function scrollTopChat(){chatDiv.scrollTop=0;}
    function scrollBottomChat(){chatDiv.scrollTop=chatDiv.scrollHeight;}
    function toggleDark(){document.body.classList.toggle("dark");try{localStorage.setItem("chat_theme",document.body.classList.contains("dark")?"dark":"light");}catch(_){ }}
    (function(){try{if(localStorage.getItem("chat_theme")==="dark")document.body.classList.add("dark");}catch(_){}})();
  </script>
</body>
</html>
